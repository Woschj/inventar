{% extends "base.html" %}

{% block title %}Verbrauchsmaterial{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Verbrauchsmaterialübersicht</h1>
        <a href="{{ url_for('add_consumable') }}" 
           class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">
            Neues Material hinzufügen
        </a>
    </div>

    <!-- Filter-Bereich -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ort</label>
            <select id="filterOrt" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="">Alle Orte</option>
                {% for ort in orte %}
                    <option value="{{ ort }}">{{ ort }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Typ</label>
            <select id="filterTyp" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="">Alle Typen</option>
                {% for typ in typen %}
                    <option value="{{ typ }}">{{ typ }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bestand</label>
            <select id="filterBestand" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="">Alle</option>
                <option value="normal">Normal</option>
                <option value="low">Niedrig</option>
                <option value="critical">Kritisch</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="filterStatus" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="">Alle Status</option>
                <option value="Verfügbar">Verfügbar</option>
                <option value="Kritisch">Kritisch</option>
                <option value="Verbraucht">Verbraucht</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sortierung</label>
            <select id="sortierung" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                <option value="bezeichnung">Bezeichnung</option>
                <option value="typ">Typ</option>
                <option value="aktueller_bestand">Bestand</option>
                <option value="status">Status</option>
            </select>
        </div>
    </div>

    <!-- Tabelle -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="consumablesTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('bezeichnung')">
                        Bezeichnung
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-bezeichnung">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('typ')">
                        Typ
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-typ">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('ort')">
                        Ort
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-ort">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('bestand')">
                        Aktueller Bestand
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-bestand">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('mindestbestand')">
                        Mindestbestand
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-mindestbestand">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('status')">
                        Status
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-status">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                        onclick="sortTable('barcode')">
                        Barcode
                        <span class="inline-block ml-1 group-hover:text-gray-700" id="sort-barcode">↕</span>
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in consumables %}
                <tr class="consumable-row">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <a href="{{ url_for('consumable_details', barcode=item.barcode) }}" 
                           class="text-blue-600 hover:text-blue-800">
                            {{ item.bezeichnung }}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.typ }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.ort }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.aktueller_bestand }} {{ item.einheit }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.mindestbestand }} {{ item.einheit }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if item.bestand_status == 'Verfügbar' %}bg-green-100 text-green-800
                            {% elif item.bestand_status == 'Kritisch' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ item.bestand_status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ item.barcode }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="confirmDelete('consumable', '{{ item.barcode }}')" 
                                class="text-red-600 hover:text-red-800">
                            <svg class="h-5 w-5 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Filterlogik ähnlich wie bei index.html
document.addEventListener('DOMContentLoaded', function() {
    const filterOrt = document.getElementById('filterOrt');
    const filterTyp = document.getElementById('filterTyp');
    const filterStatus = document.getElementById('filterStatus');
    const filterBestand = document.getElementById('filterBestand');
    const sortierung = document.getElementById('sortierung');
    const rows = document.querySelectorAll('.consumable-row');

    function filterAndSortItems() {
        const selectedOrt = filterOrt.value.toLowerCase();
        const selectedTyp = filterTyp.value.toLowerCase();
        const selectedStatus = filterStatus.value;
        const selectedBestand = filterBestand.value;
        const selectedSort = sortierung.value;

        let visibleRows = Array.from(rows);

        // Filtern
        visibleRows.forEach(row => {
            const ort = row.children[2].textContent.toLowerCase();
            const typ = row.children[1].textContent.toLowerCase();
            const status = row.children[5].textContent.trim();
            const bestand = row.children[3].textContent;

            const ortMatch = !selectedOrt || ort === selectedOrt;
            const typMatch = !selectedTyp || typ === selectedTyp;
            const statusMatch = !selectedStatus || status === selectedStatus;
            
            let bestandMatch = true;
            if (selectedBestand) {
                const currentBestand = parseInt(bestand);
                const minBestand = parseInt(row.children[4].textContent);
                
                if (selectedBestand === 'normal') {
                    bestandMatch = currentBestand > minBestand;
                } else if (selectedBestand === 'low') {
                    bestandMatch = currentBestand <= minBestand && currentBestand > 0;
                } else if (selectedBestand === 'critical') {
                    bestandMatch = currentBestand === 0;
                }
            }

            row.style.display = ortMatch && typMatch && statusMatch && bestandMatch ? '' : 'none';
        });

        // Sortieren
        visibleRows.sort((a, b) => {
            const columnIndices = {
                'bezeichnung': 0,
                'typ': 1,
                'aktueller_bestand': 3,
                'status': 5
            };
            
            const aValue = a.children[columnIndices[selectedSort]].textContent;
            const bValue = b.children[columnIndices[selectedSort]].textContent;
            
            if (selectedSort === 'aktueller_bestand') {
                return parseInt(bValue) - parseInt(aValue);
            }
            return aValue.localeCompare(bValue);
        });

        const tbody = document.querySelector('#consumablesTable tbody');
        visibleRows.forEach(row => tbody.appendChild(row));
    }

    // Event Listener für Filter
    [filterOrt, filterTyp, filterStatus, filterBestand, sortierung].forEach(filter => {
        filter.addEventListener('change', filterAndSortItems);
    });
});
</script>
{% endblock %} 