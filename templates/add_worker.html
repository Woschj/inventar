{% extends "base.html" %}

{% block title %}Neuer Mitarbeiter{% endblock %}

{% block content %}
<div class="bg-base-100 shadow rounded-lg p-6">
    <h1 class="text-2xl font-bold text-base-content mb-6">Neuen Mitarbeiter hinzufügen</h1>
    
    <form method="post" class="space-y-4">
        <div class="mb-4">
            <label class="block text-sm font-medium">Barcode</label>
            <div class="relative">
                <input type="text" 
                       name="barcode" 
                       id="barcodeInput" 
                       required
                       readonly
                       class="input input-bordered w-full pr-16"
                       placeholder="Barcode scannen...">
                <button type="button" onclick="startBarcodeScanner()"
                        class="btn btn-primary absolute right-0 top-0">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-base-content">Vorname</label>
            <input type="text" name="name" required
                   class="input input-bordered w-full">
        </div>
        <div>
            <label class="block text-sm font-medium text-base-content">Nachname</label>
            <input type="text" name="lastname" required
                   class="input input-bordered w-full">
        </div>
        <div>
            <label class="block text-sm font-medium text-base-content">Bereich</label>
            <input type="text" name="bereich"
                   class="input input-bordered w-full">
        </div>
        <div>
            <label class="block text-sm font-medium text-base-content">E-Mail</label>
            <input type="email" name="email"
                   class="input input-bordered w-full">
        </div>
        <button type="submit" 
                class="btn bg-[#5b69a7] hover:bg-[#4c5789] text-white">
            Mitarbeiter hinzufügen
        </button>
    </form>
</div>

<!-- Scanner Modal -->
<div id="scannerModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-xl shadow-2xl rounded-xl bg-base-100">
        <div class="flex flex-col">
            <!-- Header mit Kamera-Reset-Button -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-base-content">Mitarbeiter-Barcode scannen</h3>
                    <p class="text-base-content text-sm mt-1">Scannen Sie den Barcode für den Mitarbeiter</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="resetScannerCamera()" 
                            class="p-2 hover:bg-base-200 rounded-full transition-colors"
                            title="Kamera neu starten">
                        <i class="fas fa-camera-rotate text-base-content text-xl"></i>
                    </button>
                    <button onclick="closeScannerModal()" 
                            class="p-2 hover:bg-base-200 rounded-full transition-colors">
                        <i class="fas fa-times text-base-content text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Scan-Bereich -->
            <div class="relative aspect-video bg-base-200 rounded-xl overflow-hidden shadow-inner">
                <video id="scannerVideo" 
                       class="w-full h-full object-cover"
                       autoplay playsinline></video>
                <div id="scanner-overlay" 
                     class="absolute inset-0 flex items-center justify-center">
                    <div class="relative w-64 h-64">
                        <div class="absolute inset-0 border-2 border-primary rounded-lg"></div>
                        <div class="absolute inset-x-0 h-0.5 bg-primary opacity-75 animate-scan"></div>
                        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary"></div>
                        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary"></div>
                        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary"></div>
                        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary"></div>
                    </div>
                </div>
                <div id="scanner-status" 
                     class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-lg text-sm text-center">
                    Kamera wird initialisiert...
                </div>
            </div>

            <!-- Kamera-Auswahl -->
            <select id="scanner-camera-select" 
                    class="mt-4 w-full p-3 border rounded-xl hidden focus:ring-2 focus:ring-primary focus:border-primary">
            </select>
        </div>
    </div>
</div>

<script>
let scannerCodeReader;
let isScannerActive = false;
let inputBuffer = '';
let lastKeyTime = Date.now();
let isProcessingBarcode = false;
let activeInput = null;

window.addEventListener('load', () => {
    scannerCodeReader = new ZXing.BrowserMultiFormatReader();
});

async function startBarcodeScanner() {
    const modal = document.getElementById('scannerModal');
    modal.classList.remove('hidden');
    
    try {
        const videoElement = document.getElementById('scannerVideo');
        const statusElement = document.getElementById('scanner-status');
        
        const devices = await scannerCodeReader.listVideoInputDevices();
        const cameraSelect = document.getElementById('scanner-camera-select');
        
        if (devices.length > 1) {
            cameraSelect.innerHTML = devices.map(device => 
                `<option value="${device.deviceId}">${device.label || `Kamera ${device.deviceId}`}</option>`
            ).join('');
            cameraSelect.classList.remove('hidden');
            
            cameraSelect.addEventListener('change', (event) => {
                resetScannerCamera();
                startScannerCamera(event.target.value);
            });
        }
        
        await startScannerCamera(devices[0]?.deviceId);
        
    } catch (error) {
        console.error('Scanner-Fehler:', error);
        document.getElementById('scanner-status').textContent = 'Fehler beim Kamerazugriff';
    }
}

async function startScannerCamera(deviceId) {
    if (isScannerActive) return;
    
    try {
        await scannerCodeReader.decodeFromVideoDevice(
            deviceId,
            'scannerVideo',
            (result, err) => {
                if (result) {
                    const overlay = document.getElementById('scanner-overlay');
                    overlay.classList.add('scan-success');
                    
                    setTimeout(() => {
                        const barcodeInput = document.getElementById('barcodeInput');
                        barcodeInput.value = result.text;
                        showScannerSuccess('Barcode erfolgreich gescannt: ' + result.text);
                        
                        overlay.classList.remove('scan-success');
                        
                        setTimeout(() => {
                            closeScannerModal();
                        }, 500);
                    }, 300);
                }
            }
        );
        
        document.getElementById('scanner-status').textContent = 'Bereit zum Scannen';
        isScannerActive = true;
        
    } catch (error) {
        console.error('Kamera-Fehler:', error);
        document.getElementById('scanner-status').textContent = 'Fehler beim Kamerazugriff';
    }
}

function resetScannerCamera() {
    if (isScannerActive) {
        scannerCodeReader.reset();
        isScannerActive = false;
    }
}

function closeScannerModal() {
    const modal = document.getElementById('scannerModal');
    modal.classList.add('hidden');
    resetScannerCamera();
}

function showScannerSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg flex items-center space-x-2';
    successDiv.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.style.transition = 'opacity 0.5s ease-out';
        successDiv.style.opacity = '0';
        setTimeout(() => successDiv.remove(), 500);
    }, 2000);
}

// Fokussiere das Barcode-Eingabefeld beim Laden
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeInput');
    if (barcodeInput) {
        barcodeInput.focus();
        activeInput = barcodeInput;
        // Setze readonly Attribut
        barcodeInput.setAttribute('readonly', true);
    }
});

// Event Listener für Barcode-Scans
document.addEventListener('keydown', function(event) {
    const currentTime = Date.now();
    const timeDiff = currentTime - lastKeyTime;

    // Reset buffer if time between keystrokes is too long
    if (timeDiff > 100) {
        inputBuffer = '';
    }

    // Ignoriere Shift-Taste
    if (event.key === 'Shift') {
        lastKeyTime = currentTime;
        return;
    }

    // Wenn Enter gedrückt wird
    if (event.key === 'Enter' && !isProcessingBarcode) {
        event.preventDefault();
        
        // Entferne "Shift" und "Enter" aus dem Buffer und trimme Leerzeichen
        const scannedBarcode = inputBuffer.replace(/Shift|Enter/g, '').trim();
        
        if (scannedBarcode) {
            const barcodeInput = document.getElementById('barcodeInput');
            
            // Setze den Barcode ins Eingabefeld
            barcodeInput.value = scannedBarcode;
            
            // Verhindere weitere Scans für kurze Zeit
            isProcessingBarcode = true;
            setTimeout(() => {
                isProcessingBarcode = false;
            }, 1000);
            
            // Fokussiere das nächste Eingabefeld
            const nextInput = barcodeInput.closest('div').nextElementSibling?.querySelector('input');
            if (nextInput) {
                nextInput.focus();
                activeInput = nextInput;
            }

            // Optional: Zeige Erfolgsmeldung
            showScannerSuccess('Barcode erfolgreich gescannt: ' + scannedBarcode);
        }
        
        inputBuffer = '';
        return;
    }

    inputBuffer += event.key;
    lastKeyTime = currentTime;
});

// Event Listener für Fokus auf Eingabefeldern
document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"]').forEach(input => {
    input.addEventListener('focus', function() {
        activeInput = this;
    });
});
</script>
{% endblock %}