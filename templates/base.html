<!DOCTYPE html>
<html lang="de" data-theme="winter">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Werkzeugverwaltung</title>
    
    <!-- DaisyUI und Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.css" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Scanner und QR Code -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <!-- Theme -->
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#5b69a7',
                    }
                }
            },
            daisyui: {
                themes: [{
                    winter: {
                        "primary": "#5b69a7",
                        "primary-focus": "#4a5796",
                        "primary-content": "#ffffff",
                        "base-100": "#ffffff",
                        "base-200": "#f9fafb",
                        "base-300": "#d1d5db",
                        "base-content": "#1f2937",
                    }
                }],
                darkTheme: "winter",
            }
        }
    </script>

    <style>
        .logo-light {
            filter: brightness(0) saturate(100%) invert(19%) sepia(92%) 
                    saturate(1710%) hue-rotate(213deg) brightness(97%) contrast(105%);
            height: 48px;
        }
        
        [data-theme="dark"] .logo-light {
            filter: brightness(0) saturate(100%) invert(100%);
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .animate-scan {
            animation: scan 2s linear infinite;
        }

        .fade-out {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        #main-scanner-input {
            transition: border-color 0.3s ease;
        }
        
        #main-scanner-input:focus {
            border-color: theme('colors.primary');
            outline: none;
            box-shadow: 0 0 0 2px rgba(91, 105, 167, 0.2);
        }
    </style>
</head>

<body class="min-h-screen bg-base-200">
    <div class="drawer">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-base-100 shadow-lg px-4 relative">
                <div class="flex-1">
                    <!-- Linke Seite mit Logo und Menü -->
                    <div class="flex items-center">
                        <label for="drawer-toggle" class="btn btn-ghost drawer-button lg:hidden">
                            <i class="fas fa-bars"></i>
                        </label>
                        <a href="{{ url_for('index') }}" class="flex items-center">
                            <img src="{{ url_for('static', filename='images/Logo-BTZ-WEISS.svg') }}" 
                                 alt="BTZ Logo" 
                                 class="logo-light">
                        </a>
                        <!-- Hauptmenü (nur Desktop) -->
                        <div class="hidden lg:flex ml-4">
                            <a href="{{ url_for('index') }}" 
                               class="btn btn-ghost {% if request.endpoint == 'index' %}btn-active{% endif %}">
                                <i class="fas fa-tools mr-2"></i>Werkzeuge
                            </a>
                            <a href="{{ url_for('consumables') }}" 
                               class="btn btn-ghost {% if request.endpoint == 'consumables' %}btn-active{% endif %}">
                                <i class="fas fa-box-open mr-2"></i>Verbrauchsmaterial
                            </a>
                            {% if session.get('is_admin') %}
                            <a href="{{ url_for('workers') }}" 
                               class="btn btn-ghost {% if request.endpoint == 'workers' %}btn-active{% endif %}">
                                <i class="fas fa-users mr-2"></i>Mitarbeiter
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- QuickScan Button in der Navbar -->
                <button onclick="showQuickScan()" 
                        class="btn btn-circle bg-[#5b69a7] text-white hover:bg-[#4c5789] absolute left-1/2 transform -translate-x-1/2 z-10"
                        style="transform: scale(3);">
                    <i class="fas fa-barcode"></i>
                </button>
                
                <div class="flex-none">
                    <!-- Rechte Navigation -->
                    <div class="hidden lg:flex items-center gap-4">
                        {% if session.get('is_admin') %}
                        <a href="{{ url_for('manual_lending') }}"
                           class="btn btn-ghost {% if request.endpoint == 'manual_lending' %}btn-active{% endif %}">
                            <i class="fas fa-hand-holding mr-2"></i>Manuell
                        </a>
                        <a href="{{ url_for('admin_panel') }}"
                           class="btn btn-ghost {% if request.endpoint == 'admin_panel' %}btn-active{% endif %}">
                            <i class="fas fa-tachometer-alt mr-2"></i>Admin
                        </a>
                        {% endif %}

                        <!-- Theme Toggle -->
                        <label class="swap swap-rotate btn btn-ghost btn-circle">
                            <input type="checkbox" class="theme-controller" value="dark" />
                            <i class="fas fa-sun swap-on"></i>
                            <i class="fas fa-moon swap-off"></i>
                        </label>

                        <!-- Login/Logout -->
                        {% if session.get('is_admin') %}
                        <a href="{{ url_for('logout') }}" class="btn btn-ghost">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                        {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-ghost">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- QuickScan Modal -->
            <dialog id="quickScanModal" class="modal">
                <form method="dialog" class="modal-box relative max-w-2xl overflow-y-auto max-h-[90vh] z-40">
                    <!-- Verstecktes Input-Feld -->
                    <input type="text" 
                           id="main-scanner-input"
                           class="w-0 h-0 opacity-0 absolute"
                           autocomplete="off">
                    
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-2xl">QuickScan</h3>
                        <button class="btn btn-sm btn-circle" onclick="resetQuickScan()">✕</button>
                    </div>

                    <!-- Scan Steps -->
                    <div id="scan-steps" class="mb-6">
                        <!-- Step 1: Werkzeug -->
                        <div id="step-tool" class="scan-step">
                            <div class="text-center mb-6">
                                <i class="fas fa-tools text-5xl text-primary mb-4"></i>
                                <h4 class="text-xl font-bold mb-2">Werkzeug scannen</h4>
                                <p class="text-sm opacity-70">Bitte scannen Sie den Barcode des Werkzeugs</p>
                            </div>
                            <div id="tool-preview" class="rounded-xl transition-all duration-300">
                                <div class="text-center">
                                    <p class="font-bold text-xl">---</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Mitarbeiter -->
                        <div id="step-worker" class="scan-step" style="display: none;">
                            <div class="text-center mb-6">
                                <i class="fas fa-user text-5xl text-primary mb-4"></i>
                                <h4 class="text-xl font-bold mb-2">Mitarbeiter scannen</h4>
                                <p class="text-sm opacity-70">Bitte scannen Sie den Mitarbeiterausweis</p>
                            </div>
                            <div id="worker-preview" class="bg-base-200 rounded-xl p-6">
                                <div class="text-center">
                                    <p class="font-bold text-xl">---</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Bestätigung -->
                        <div id="step-confirm" class="scan-step" style="display: none;">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                    </div>

                    <!-- Scan Animation -->
                    <div class="relative h-1 bg-base-200">
                        <div class="absolute top-0 left-0 w-full h-full">
                            <div class="h-1 bg-primary opacity-50 animate-scan"></div>
                        </div>
                    </div>
                </form>
            </dialog>

            <!-- Main Content -->
            <main class="container mx-auto px-4 py-8 relative z-0">
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert {% if category == 'error' %}alert-error{% else %}alert-success{% endif %} mb-4">
                            <i class="fas {% if category == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                            <span>{{ message }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>
        </div>

        <!-- Mobile Drawer -->
        <div class="drawer-side z-30">
            <label for="drawer-toggle" class="drawer-overlay"></label>
            <ul class="menu p-4 w-80 h-full bg-base-200 gap-2">
                <li>
                    <a href="{{ url_for('index') }}" 
                       class="{% if request.endpoint == 'index' %}active{% endif %}">
                        <i class="fas fa-tools"></i>Werkzeuge
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('consumables') }}" 
                       class="{% if request.endpoint == 'consumables' %}active{% endif %}">
                        <i class="fas fa-box-open"></i>Verbrauchsmaterial
                    </a>
                </li>
                {% if session.get('is_admin') %}
                <li>
                    <a href="{{ url_for('workers') }}"
                       class="{% if request.endpoint == 'workers' %}active{% endif %}">
                        <i class="fas fa-users"></i>Mitarbeiter
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('manual_lending') }}" 
                       class="{% if request.endpoint == 'manual_lending' %}active{% endif %}">
                        <i class="fas fa-hand-holding"></i>Manuell Ausleihen
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- QR-Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">QuickScan QR-Code</h3>
            <div class="flex justify-center mb-4">
                <div id="qrcode"></div>
            </div>
            <p class="text-center text-sm mb-4">Scannen Sie diesen Code mit dem Barcodescanner, um den QuickScan zu starten</p>
            <div class="modal-action">
                <button class="btn" onclick="closeQRModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script>
        // Globale Variablen
        let currentStep = 'tool';
        let scannedTool = null;
        let scannedWorker = null;

        // Feedback-Funktion definieren
        function showFeedback(message, type = 'info') {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `alert alert-${type} fixed bottom-4 right-4 z-50`;
            feedbackDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                  type === 'error' ? 'exclamation-circle' : 
                                  'info-circle'} mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(feedbackDiv);
            
            setTimeout(() => {
                feedbackDiv.classList.add('fade-out');
                setTimeout(() => feedbackDiv.remove(), 300);
            }, 3000);
        }

        async function processBarcodeInput(barcode) {
            console.log('Verarbeite Barcode:', barcode, 'Aktueller Schritt:', currentStep);
            
            try {
                // Prüfe Bestätigungscodes
                if (barcode.startsWith('NEXT') && window.currentConfirmCode) {
                    if (barcode === window.currentConfirmCode) {
                        if (currentStep === 'tool') {
                            // Wechsel zu Mitarbeiter-Scan
                            currentStep = 'worker';
                            document.getElementById('step-tool').style.display = 'none';
                            document.getElementById('step-worker').style.display = 'block';
                            showFeedback('Bitte Mitarbeiterausweis scannen', 'info');
                        } else if (currentStep === 'worker_confirm') {
                            // Wechsel zur finalen Bestätigung
                            currentStep = 'final_confirm';
                            showConfirmationStep();
                        }
                        return;
                    }
                }
                
                // Finale Bestätigung
                if (currentStep === 'final_confirm' && barcode === window.finalConfirmCode) {
                    await processTransaction(scannedTool, scannedWorker);
                    return;
                }

                // Normale Verarbeitung wie bisher...
                if (currentStep === 'tool' && !barcode.startsWith('NEXT')) {
                    const response = await fetch(`/api/get_item/${encodeURIComponent(barcode)}`);
                    const data = await response.json();
                    
                    if (data.valid) {
                        console.log('Werkzeug erkannt:', data);
                        scannedTool = data.data;
                        
                        const toolPreview = document.getElementById('tool-preview');
                        toolPreview.innerHTML = `
                            <div class="text-center bg-green-100 p-6 rounded-xl border-2 border-green-500">
                                <i class="fas fa-tools text-4xl mb-3 text-green-600"></i>
                                <p class="text-lg mb-2 text-green-800">Werkzeug erkannt</p>
                                <p class="font-bold text-xl text-green-800">${data.data.gegenstand}</p>
                                <p class="text-sm mt-2 text-green-600">ID: ${data.data.barcode}</p>
                            </div>
                            <div class="mt-6 text-center">
                                <p class="text-sm text-gray-600 mb-2">Scannen Sie diesen Code zum Fortfahren:</p>
                                <svg id="nextStepBarcode" class="mx-auto"></svg>
                            </div>
                        `;

                        const confirmCode = 'NEXT' + Math.random().toString(36).substr(2, 9).toUpperCase();
                        console.log('Neuer Bestätigungscode generiert:', confirmCode);
                        
                        JsBarcode("#nextStepBarcode", confirmCode, {
                            format: "CODE128",
                            width: 2,
                            height: 100,
                            displayValue: false
                        });

                        window.currentConfirmCode = confirmCode;
                    }
                }
                // Mitarbeiter-Scan
                else if (currentStep === 'worker') {
                    const response = await fetch(`/api/get_worker/${encodeURIComponent(barcode)}`);
                    const data = await response.json();
                    
                    if (data && data.name) {
                        console.log('Mitarbeiter erkannt:', data);
                        scannedWorker = data;
                        
                        const workerPreview = document.getElementById('worker-preview');
                        workerPreview.innerHTML = `
                            <div class="text-center bg-green-100 p-6 rounded-xl border-2 border-green-500">
                                <i class="fas fa-user text-4xl mb-3 text-green-600"></i>
                                <p class="text-lg mb-2 text-green-800">Mitarbeiter erkannt</p>
                                <p class="font-bold text-xl text-green-800">${data.name} ${data.lastname}</p>
                                <p class="text-sm mt-2 text-green-600">ID: ${data.barcode}</p>
                                <p class="text-sm text-green-600">${data.bereich}</p>
                            </div>
                            <div class="mt-6 text-center">
                                <p class="text-sm text-gray-600 mb-2">Scannen Sie diesen Code zum Fortfahren:</p>
                                <svg id="workerConfirmBarcode" class="mx-auto"></svg>
                            </div>
                        `;
                        
                        // Generiere Bestätigungscode für den nächsten Schritt
                        const confirmCode = 'NEXT' + Math.random().toString(36).substr(2, 9).toUpperCase();
                        JsBarcode("#workerConfirmBarcode", confirmCode, {
                            format: "CODE128",
                            width: 2,
                            height: 100,
                            displayValue: false
                        });
                        
                        window.currentConfirmCode = confirmCode;
                        currentStep = 'worker_confirm';
                    }
                }
            } catch (error) {
                console.error('Fehler:', error);
                showFeedback('Fehler bei der Verarbeitung', 'error');
            }
        }

        // Neue Funktion für den finalen Bestätigungsschritt
        function showConfirmationStep() {
            const stepTool = document.getElementById('step-tool');
            const stepWorker = document.getElementById('step-worker');
            const stepConfirm = document.getElementById('step-confirm');
            
            stepTool.style.display = 'none';
            stepWorker.style.display = 'none';
            stepConfirm.style.display = 'block';
            
            // Zusammenfassung anzeigen
            stepConfirm.innerHTML = `
                <div class="text-center mb-6">
                    <i class="fas fa-check-circle text-5xl text-success mb-4"></i>
                    <h4 class="text-xl font-bold mb-2">Vorgang bestätigen</h4>
                    <p class="text-sm opacity-70">Bitte prüfen Sie die Details und scannen Sie den Code zur Bestätigung</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Werkzeug-Info -->
                    <div class="bg-green-100 p-4 rounded-xl border-2 border-green-500">
                        <h5 class="font-bold mb-2">Werkzeug</h5>
                        <p>${scannedTool.gegenstand}</p>
                        <p class="text-sm text-green-600">ID: ${scannedTool.barcode}</p>
                    </div>
                    
                    <!-- Mitarbeiter-Info -->
                    <div class="bg-green-100 p-4 rounded-xl border-2 border-green-500">
                        <h5 class="font-bold mb-2">Mitarbeiter</h5>
                        <p>${scannedWorker.name} ${scannedWorker.lastname}</p>
                        <p class="text-sm text-green-600">ID: ${scannedWorker.barcode}</p>
                        <p class="text-sm text-green-600">${scannedWorker.bereich}</p>
                    </div>
                </div>
                
                <!-- Finaler Bestätigungscode -->
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">Scannen Sie diesen Code zur finalen Bestätigung:</p>
                    <svg id="finalConfirmBarcode" class="mx-auto"></svg>
                </div>
            `;
            
            // Generiere finalen Bestätigungscode
            const finalCode = 'FINAL' + Math.random().toString(36).substr(2, 9).toUpperCase();
            JsBarcode("#finalConfirmBarcode", finalCode, {
                format: "CODE128",
                width: 2,
                height: 100,
                displayValue: false
            });
            
            window.finalConfirmCode = finalCode;
        }

        // Event-Listener für Barcode-Eingabe
        document.getElementById('main-scanner-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = this.value.trim();
                console.log('Gescannter Barcode:', barcode);
                
                if (barcode) {
                    processBarcodeInput(barcode);
                }
                this.value = '';
            }
        });

        // Verhindere Scroll-Reset bei Formulareingaben
        document.getElementById('quickScanModal').querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();
        });

        function showQuickScan() {
            const modal = document.getElementById('quickScanModal');
            if (modal) {
                // Reset beim Öffnen
                currentStep = 'tool';
                scannedTool = null;
                scannedWorker = null;
                
                // Schritte zurücksetzen
                document.getElementById('step-tool').style.display = 'block';
                document.getElementById('step-worker').style.display = 'none';
                document.getElementById('step-confirm').style.display = 'none';
                
                // Modal öffnen
                modal.showModal();
                
                // Scanner fokussieren
                const scannerInput = document.getElementById('main-scanner-input');
                if (scannerInput) {
                    scannerInput.value = '';
                    scannerInput.focus();
                }
            }
        }

        function resetQuickScan() {
            const modal = document.getElementById('quickScanModal');
            if (modal) {
                modal.close();
            }
            
            // Alles zurücksetzen
            currentStep = 'tool';
            scannedTool = null;
            scannedWorker = null;
            
            // Previews zurücksetzen
            const toolPreview = document.getElementById('tool-preview');
            const workerPreview = document.getElementById('worker-preview');
            
            if (toolPreview) {
                toolPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-tools text-4xl mb-3 text-primary"></i>
                        <p class="text-lg mb-2">Werkzeug</p>
                        <p class="font-bold text-xl">---</p>
                    </div>
                `;
            }
            
            if (workerPreview) {
                workerPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user text-4xl mb-3 text-primary"></i>
                        <p class="text-lg mb-2">Mitarbeiter</p>
                        <p class="font-bold text-xl">---</p>
                    </div>
                `;
            }
        }

        // Initialisierung beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Scanner wird initialisiert...');
            const scannerInput = document.getElementById('main-scanner-input');
            if (scannerInput) {
                scannerInput.focus();
            }
        });

        function generateConfirmationQR() {
            const confirmDiv = document.getElementById('confirm-qr');
            if (confirmDiv) {
                const code = generateConfirmationCode();
                // QR Code generieren (benötigt qrcode.js)
                const qr = new QRCode(confirmDiv, {
                    text: code,
                    width: 200,
                    height: 200
                });
            }
        }

        function generateConfirmationCode() {
            // Eindeutigen Code generieren
            return `CONFIRM-${Date.now()}`;
        }

        // Verbesserte Display-Funktion für das Modal
        function displayToolDetails(item, type) {
            const toolPreview = document.getElementById('tool-preview');
            if (!toolPreview) return;

            const displayName = type === 'tool' ? item.gegenstand : item.bezeichnung;
            const icon = type === 'tool' ? 'tools' : 'box-open';
            const typeText = type === 'tool' ? 'Werkzeug' : 'Verbrauchsmaterial';

            toolPreview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-${icon} text-4xl mb-3 text-primary"></i>
                    <p class="text-lg mb-2">${typeText}</p>
                    <p class="font-bold text-xl">${displayName}</p>
                    <p class="text-sm mt-2 opacity-70">ID: ${item.barcode}</p>
                </div>
            `;
            toolPreview.classList.add('border-primary', 'border-2');
        }

        // Verbesserte Reset-Funktion
        function resetPreviews() {
            const toolPreview = document.getElementById('tool-preview');
            const workerPreview = document.getElementById('worker-preview');

            if (toolPreview) {
                toolPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-tools text-4xl mb-3 text-primary"></i>
                        <p class="text-lg mb-2">Werkzeug</p>
                        <p class="font-bold text-xl">---</p>
                    </div>
                `;
                toolPreview.classList.remove('border-primary', 'border-2');
            }

            if (workerPreview) {
                workerPreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-user text-4xl mb-3 text-primary"></i>
                        <p class="text-lg mb-2">Mitarbeiter</p>
                        <p class="font-bold text-xl">---</p>
                    </div>
                `;
                workerPreview.classList.remove('border-primary', 'border-2');
            }
        }

        // CSS für die Scan-Animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes scan {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
            
            .animate-scan {
                animation: scan 2s linear infinite;
            }

            .scan-step {
                transition: all 0.3s ease-in-out;
            }

            .scan-step.active {
                transform: translateX(0);
                opacity: 1;
            }

            .scan-step.hidden {
                display: none;
                transform: translateX(50px);
                opacity: 0;
            }
        `;
        document.head.appendChild(style);

        async function processTransaction(tool, worker) {
            try {
                console.log('Verarbeite Transaktion:', { tool, worker });
                
                // Bestimme den Endpunkt basierend auf dem Typ und Status
                let endpoint = '/api/process_lending';  // Standard-Endpunkt für alle Transaktionen
                let requestData;
                
                if (tool.type === 'consumable') {
                    requestData = {
                        type: 'consumable',
                        barcode: tool.barcode,
                        worker_barcode: worker.barcode,
                        amount: 1
                    };
                } else {
                    // Werkzeug
                    requestData = {
                        type: 'tool',
                        barcode: tool.barcode,
                        worker_barcode: worker.barcode,
                        action: tool.status === 'Ausgeliehen' ? 'return' : 'lend'
                    };
                }
                
                console.log('Sende Anfrage an:', endpoint, 'mit Daten:', requestData);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                console.log('Transaktions-Ergebnis:', result);
                
                if (result.success) {
                    showFeedback('Vorgang erfolgreich abgeschlossen', 'success');
                    setTimeout(() => {
                        const modal = document.getElementById('quickScanModal');
                        if (modal) {
                            modal.close();
                        }
                        location.reload();
                    }, 2000);
                } else {
                    showFeedback(result.message || 'Fehler bei der Verarbeitung', 'error');
                    console.error('Transaktionsfehler:', result);
                }
            } catch (error) {
                console.error('Fehler bei der Transaktion:', error);
                showFeedback('Fehler bei der Verarbeitung: ' + error.message, 'error');
            }
        }
    </script>

    <style>
        #qrcode img {
            margin: 0 auto;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #5b69a7;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        #quickScanBtn {
            background-color: #5b69a7; /* BTZ Blau */
            border: 4px solid #ffffff; /* Weißer Rand */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #quickScanBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(91, 105, 167, 0.5);
        }

        #quickScanQR {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #quickScanQR canvas {
            width: 100% !important;
            height: 100% !important;
        }

        #quickScanBtn {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        #quickScanBtn:hover {
            box-shadow: 0 0 30px rgba(91, 105, 167, 0.3);
        }
        
        @media (max-width: 640px) {
            #quickScanBtn {
                bottom: 2rem;
            }
        }
    </style>
</body>
</html>